<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
		<style>
			.popup-message {
				position: fixed;
				top: 10%;
				left: 50%;
				transform: translateX(-50%);
				z-index: 50;
				padding: 10px 20px;
				border-radius: 8px;
				background-color: #48bb78; /* Tailwind's green-500 */
				color: white;
				display: none;
				opacity: 0;
				transition: opacity 0.5s ease;
			}
			.popup-message.error {
				background-color: #f56565; /* Tailwind's red-500 */
			}
			.popup-message.show {
				display: block;
				opacity: 1;
			}
		</style>
	</head>
	<body class="flex h-screen bg-gray-100">
		<div class="flex flex-col md:flex-row w-full">
			<!-- Sidebar -->
			<nav
				class="bg-white md:w-16 w-full md:h-full h-16 fixed md:fixed bottom-0 md:bottom-auto flex md:flex-col md:justify-between shadow-lg"
			>
				<div
					class="flex md:flex-col items-center mobile-centered md:mt-4 space-x-4 md:space-x-0 md:space-y-4 w-full"
				>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="summary-tab"
						data-tab="summary"
					>
						<i class="far fa-heart text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Summary</span
						>
					</div>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="profile-tab"
						data-tab="profile"
					>
						<i class="far fa-user text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Profile</span
						>
					</div>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="explore-tab"
						data-tab="explore"
					>
						<i class="far fa-compass text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Explore</span
						>
					</div>
				</div>
				<div
					class="md:mb-4 flex md:flex-col items-center justify-around md:justify-end space-x-4 md:space-x-0 md:space-y-4 logout-icon hidden md:flex"
				>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="logout-tab"
						onclick="location.href='{{ url_for('auth.sign_out') }}'"
					>
						<i
							class="far fa-sign-out-alt text-gray-600 text-lg md:text-2xl"
						></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Logout</span
						>
					</div>
				</div>
			</nav>

			<!-- Main Content -->
			<main class="flex-1 p-4 md:ml-16" id="main-content">
				<!-- Initial content will be loaded here -->
			</main>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const icons = document.querySelectorAll(".sidebar-icon");

				function loadContent(tabId, callback) {
					let url = `/${tabId}`;
					if (tabId === "explore") {
						url = "{{ url_for('main.explore_content') }}";
					} else if (tabId === "heart_rate") {
						url = "{{ url_for('main.heart_rate') }}";
					} else if (tabId === "cholesterol") {
						url = "{{ url_for('main.cholesterol') }}";
					} else if (tabId === "glucose") {
						url = "{{ url_for('main.glucose') }}";
					}
					fetch(url)
						.then((response) => response.text())
						.then((html) => {
							document.getElementById("main-content").innerHTML = html;
							if (tabId === "explore") {
								setupExplorePage();
							}
							if (callback) callback(tabId);
							if (tabId === "blood_pressure") {
								setupBloodPressurePage();
							}
							if (tabId === "heart_rate") {
								setupHeartRatePage();
							}
							if (tabId === "glucose") {
								setupGlucosePage();
							}
							if (tabId === "cholesterol") {
								setupCholesterolPage();
							}
						})
						.catch((error) => console.warn("Error loading content:", error));
				}

				function activateTab(tabId, shouldLoadContent = true) {
					localStorage.setItem("activeTab", tabId);

					if (shouldLoadContent) {
						loadContent(tabId, setActiveIcon);
					} else {
						setActiveIcon(tabId);
					}
				}

				function setActiveIcon(tabId) {
					icons.forEach((i) => {
						const iconLabel = i.querySelector(".icon-label");
						const icon = i.querySelector("i");
						const iconClass = icon.className.split(" ")[1];
						if (iconLabel) {
							iconLabel.classList.remove("active");
							iconLabel.style.color = "#6b7280";
						}
						if (icon) {
							icon.className = `far ${iconClass}`;
							icon.style.color = "#6b7280";
						}
					});

					const activeIcon = document.querySelector(`#${tabId}-tab`);
					if (activeIcon) {
						const activeLabel = activeIcon.querySelector(".icon-label");
						const activeIconElement = activeIcon.querySelector("i");
						const iconClass = activeIconElement.className.split(" ")[1];
						if (activeLabel) {
							activeLabel.classList.add("active");
							activeLabel.style.color = "#b91c1c";
						}
						if (activeIconElement) {
							activeIconElement.className = `fas ${iconClass}`;
							activeIconElement.style.color = "#b91c1c";
						}
					}
				}

				function setupExplorePage() {
					document
						.getElementById("bp-link")
						.addEventListener("click", function (event) {
							event.preventDefault();
							loadContent("blood_pressure", () => setActiveIcon("explore"));
						});

					document
						.getElementById("hr-link")
						.addEventListener("click", function (event) {
							event.preventDefault();
							loadContent("heart_rate", () => setActiveIcon("explore"));
						});

					document
						.getElementById("cholesterol-link")
						.addEventListener("click", function (event) {
							event.preventDefault();
							loadContent("cholesterol", () => setActiveIcon("explore"));
						});

					document
						.getElementById("glucose-link")
						.addEventListener("click", function (event) {
							event.preventDefault();
							loadContent("glucose", () => setActiveIcon("explore"));
						});
				}

				function setupCholesterolPage() {
					console.log("Setting up Cholesterol Page");

					const addDataButton = document.getElementById("addDataButton");
					const addDataModal = document.getElementById("addDataModal");
					const closeModalButton = document.getElementById("closeModalButton");
					const closeModalButtonTop = document.getElementById(
						"closeModalButtonTop"
					);
					const addDataForm = document.getElementById("addDataForm");
					const formMessage = document.getElementById("formMessage");
					const formErrorMessage = document.getElementById("formErrorMessage");
					const dayViewButton = document.getElementById("dayView");
					const weekViewButton = document.getElementById("weekView");
					const monthViewButton = document.getElementById("monthView");

					let cholesterolChart;

					const closeModal = () => {
						addDataModal.classList.add("hidden");
					};

					const showMessage = (message, isSuccess = true) => {
						const messageContainer = document.createElement("div");
						messageContainer.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg ${
							isSuccess ? "bg-green-500 text-white" : "bg-red-500 text-white"
						}`;
						messageContainer.textContent = message;
						document.body.appendChild(messageContainer);

						setTimeout(() => {
							messageContainer.remove();
						}, 3000);
					};

					addDataButton.addEventListener("click", function () {
						addDataModal.classList.remove("hidden");
					});

					closeModalButton.addEventListener("click", closeModal);
					closeModalButtonTop.addEventListener("click", closeModal);

					addDataForm.addEventListener("submit", function (event) {
						event.preventDefault();
						const formData = new FormData(addDataForm);

						fetch(addDataForm.action, {
							method: "POST",
							body: formData,
						})
							.then((response) => response.json())
							.then((data) => {
								if (data.success) {
									showMessage("Data added successfully!", true);
									fetchData("day");
								} else {
									showMessage("Error adding data!", false);
								}
							})
							.catch((error) => {
								showMessage("Error adding data!", false);
								console.error("Error:", error);
							});
					});

					const fetchData = (view) => {
						fetch(`{{ url_for('main.cholesterol_data') }}?view=${view}`)
							.then((response) => response.json())
							.then((data) => {
								console.log("Data fetched for view:", view, data); // Debugging
								updateChart(data);
							})
							.catch((error) => console.error("Error fetching data:", error));
					};

					const updateChart = (data) => {
						const ctx = document
							.getElementById("cholesterolChart")
							.getContext("2d");
						if (cholesterolChart) {
							cholesterolChart.destroy();
						}
						cholesterolChart = new Chart(ctx, {
							type: "line",
							data: {
								datasets: [
									{
										label: "Cholesterol Level",
										data: data.map((entry) => ({
											x: moment(entry.timestamp),
											y: entry.cholesterol_level,
										})),
										borderColor: "rgb(255, 99, 132)",
										fill: false,
									},
								],
							},
							options: {
								scales: {
									x: {
										type: "time",
										time: {
											unit: "day",
										},
									},
									y: {
										beginAtZero: false,
									},
								},
							},
						});
					};

					dayViewButton.addEventListener("click", () => fetchData("day"));
					weekViewButton.addEventListener("click", () => fetchData("week"));
					monthViewButton.addEventListener("click", () => fetchData("month"));

					// Initialize the chart with the default view
					fetchData("day");
				}

				function setupBloodPressurePage() {
					console.log("Setting up Blood Pressure Page");

					const addDataButton = document.getElementById("addDataButton");
					const addDataModal = document.getElementById("addDataModal");
					const closeModalButton = document.getElementById("closeModalButton");
					const closeModalButtonTop = document.getElementById(
						"closeModalButtonTop"
					);
					const addDataForm = document.getElementById("addDataForm");
					const formMessage = document.getElementById("formMessage");
					const formErrorMessage = document.getElementById("formErrorMessage");
					const dayViewButton = document.getElementById("dayView");
					const weekViewButton = document.getElementById("weekView");
					const monthViewButton = document.getElementById("monthView");

					let bpChart;

					if (addDataButton) {
						addDataButton.addEventListener("click", function () {
							console.log("Add Data button clicked");
							addDataModal.classList.remove("hidden");
							console.log("Modal should be visible now");
						});
					} else {
						console.error("Add Data button not found");
					}

					if (closeModalButton) {
						closeModalButton.addEventListener("click", function () {
							console.log("Close button clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button not found");
					}

					if (closeModalButtonTop) {
						closeModalButtonTop.addEventListener("click", function () {
							console.log("Close button (top) clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button (top) not found");
					}

					if (addDataForm) {
						addDataForm.addEventListener("submit", function (event) {
							event.preventDefault();
							console.log("Form submitted");
							const formData = new FormData(addDataForm);

							fetch(addDataForm.action, {
								method: "POST",
								body: formData,
							})
								.then((response) => response.json())
								.then((data) => {
									if (data.success) {
										console.log("Data added successfully");
										formMessage.classList.remove("hidden");
										formErrorMessage.classList.add("hidden");
										formMessage.textContent = "Data added successfully!";
										setTimeout(() => {
											formMessage.classList.add("hidden");
											addDataModal.classList.add("hidden");
											fetchData("day");
										}, 2000);
									} else {
										console.log("Error adding data");
										formErrorMessage.classList.remove("hidden");
										formMessage.classList.add("hidden");
										formErrorMessage.textContent = "Error adding data!";
									}
								})
								.catch((error) => {
									console.log("Error:", error);
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								});
						});
					} else {
						console.error("Add Data form not found");
					}

					function fetchData(view) {
						console.log("Fetching data for view:", view);
						fetch(`{{ url_for('main.blood_pressure_data') }}?view=${view}`)
							.then((response) => response.json())
							.then((data) => {
								console.log("Data fetched:", data);
								updateChart(data);
							})
							.catch((error) => console.error("Error fetching data:", error));
					}

					function updateChart(data) {
						console.log("Updating chart with data:", data);
						const ctx = document.getElementById("bpChart").getContext("2d");
						if (bpChart) {
							bpChart.destroy();
						}
						bpChart = new Chart(ctx, {
							type: "line",
							data: {
								datasets: [
									{
										label: "Systolic",
										data: data.map((entry) => ({
											x: moment(entry.timestamp),
											y: entry.systolic,
										})),
										borderColor: "rgb(255, 99, 132)",
										fill: false,
									},
									{
										label: "Diastolic",
										data: data.map((entry) => ({
											x: moment(entry.timestamp),
											y: entry.diastolic,
										})),
										borderColor: "rgb(54, 162, 235)",
										fill: false,
									},
								],
							},
							options: {
								scales: {
									x: {
										type: "time",
										time: {
											unit: "day",
										},
									},
									y: {
										beginAtZero: false,
									},
								},
							},
						});
					}

					if (dayViewButton) {
						dayViewButton.addEventListener("click", () => fetchData("day"));
					} else {
						console.error("Day view button not found");
					}

					if (weekViewButton) {
						weekViewButton.addEventListener("click", () => fetchData("week"));
					} else {
						console.error("Week view button not found");
					}

					if (monthViewButton) {
						monthViewButton.addEventListener("click", () => fetchData("month"));
					} else {
						console.error("Month view button not found");
					}

					fetchData("day");
				}

				function setupHeartRatePage() {
					console.log("Setting up Heart Rate Page");

					const addDataButton = document.getElementById("addDataButton");
					const addDataModal = document.getElementById("addDataModal");
					const closeModalButton = document.getElementById("closeModalButton");
					const closeModalButtonTop = document.getElementById(
						"closeModalButtonTop"
					);
					const addDataForm = document.getElementById("addDataForm");
					const formMessage = document.getElementById("formMessage");
					const formErrorMessage = document.getElementById("formErrorMessage");
					const dayViewButton = document.getElementById("dayView");
					const weekViewButton = document.getElementById("weekView");
					const monthViewButton = document.getElementById("monthView");

					let hrChart;

					if (addDataButton) {
						addDataButton.addEventListener("click", function () {
							console.log("Add Data button clicked");
							addDataModal.classList.remove("hidden");
							console.log("Modal should be visible now");
						});
					} else {
						console.error("Add Data button not found");
					}

					if (closeModalButton) {
						closeModalButton.addEventListener("click", function () {
							console.log("Close button clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button not found");
					}

					if (closeModalButtonTop) {
						closeModalButtonTop.addEventListener("click", function () {
							console.log("Close button (top) clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button (top) not found");
					}

					if (addDataForm) {
						addDataForm.addEventListener("submit", function (event) {
							event.preventDefault();
							console.log("Form submitted");
							const formData = new FormData(addDataForm);

							fetch(addDataForm.action, {
								method: "POST",
								body: formData,
							})
								.then((response) => response.json())
								.then((data) => {
									if (data.success) {
										console.log("Data added successfully");
										formMessage.classList.remove("hidden");
										formErrorMessage.classList.add("hidden");
										formMessage.textContent = "Data added successfully!";
										setTimeout(() => {
											formMessage.classList.add("hidden");
											addDataModal.classList.add("hidden");
											fetchData("day");
										}, 2000);
									} else {
										console.log("Error adding data");
										formErrorMessage.classList.remove("hidden");
										formMessage.classList.add("hidden");
										formErrorMessage.textContent = "Error adding data!";
									}
								})
								.catch((error) => {
									console.log("Error:", error);
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								});
						});
					} else {
						console.error("Add Data form not found");
					}

					function fetchData(view) {
						console.log("Fetching data for view:", view);
						fetch(`{{ url_for('main.heart_rate_data') }}?view=${view}`)
							.then((response) => response.json())
							.then((data) => {
								console.log("Data fetched:", data);
								updateChart(data);
							})
							.catch((error) => console.error("Error fetching data:", error));
					}

					function updateChart(data) {
						console.log("Updating chart with data:", data);
						const ctx = document.getElementById("hrChart").getContext("2d");
						if (hrChart) {
							hrChart.destroy();
						}
						hrChart = new Chart(ctx, {
							type: "line",
							data: {
								datasets: [
									{
										label: "Heart Rate",
										data: data.map((entry) => ({
											x: moment(entry.timestamp),
											y: entry.heart_rate,
										})),
										borderColor: "rgb(255, 99, 132)",
										fill: false,
									},
								],
							},
							options: {
								scales: {
									x: {
										type: "time",
										time: {
											unit: "day",
										},
									},
									y: {
										beginAtZero: false,
									},
								},
							},
						});
					}

					if (dayViewButton) {
						dayViewButton.addEventListener("click", () => fetchData("day"));
					} else {
						console.error("Day view button not found");
					}

					if (weekViewButton) {
						weekViewButton.addEventListener("click", () => fetchData("week"));
					} else {
						console.error("Week view button not found");
					}

					if (monthViewButton) {
						monthViewButton.addEventListener("click", () => fetchData("month"));
					} else {
						console.error("Month view button not found");
					}

					fetchData("day");
				}

				function setupGlucosePage() {
					console.log("Setting up Glucose Page");

					const addDataButton = document.getElementById("addDataButton");
					const addDataModal = document.getElementById("addDataModal");
					const closeModalButton = document.getElementById("closeModalButton");
					const closeModalButtonTop = document.getElementById(
						"closeModalButtonTop"
					);
					const addDataForm = document.getElementById("addDataForm");
					const formMessage = document.getElementById("formMessage");
					const formErrorMessage = document.getElementById("formErrorMessage");
					const dayViewButton = document.getElementById("dayView");
					const weekViewButton = document.getElementById("weekView");
					const monthViewButton = document.getElementById("monthView");

					let glucoseChart;

					if (addDataButton) {
						addDataButton.addEventListener("click", function () {
							console.log("Add Data button clicked");
							addDataModal.classList.remove("hidden");
							console.log("Modal should be visible now");
						});
					} else {
						console.error("Add Data button not found");
					}

					if (closeModalButton) {
						closeModalButton.addEventListener("click", function () {
							console.log("Close button clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button not found");
					}

					if (closeModalButtonTop) {
						closeModalButtonTop.addEventListener("click", function () {
							console.log("Close button (top) clicked");
							addDataModal.classList.add("hidden");
						});
					} else {
						console.error("Close button (top) not found");
					}

					if (addDataForm) {
						addDataForm.addEventListener("submit", function (event) {
							event.preventDefault();
							console.log("Form submitted");
							const formData = new FormData(addDataForm);

							fetch(addDataForm.action, {
								method: "POST",
								body: formData,
							})
								.then((response) => response.json())
								.then((data) => {
									if (data.success) {
										console.log("Data added successfully");
										formMessage.classList.remove("hidden");
										formErrorMessage.classList.add("hidden");
										formMessage.textContent = "Data added successfully!";
										setTimeout(() => {
											formMessage.classList.add("hidden");
											addDataModal.classList.add("hidden");
											fetchData("day");
										}, 2000);
									} else {
										console.log("Error adding data");
										formErrorMessage.classList.remove("hidden");
										formMessage.classList.add("hidden");
										formErrorMessage.textContent = "Error adding data!";
									}
								})
								.catch((error) => {
									console.log("Error:", error);
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								});
						});
					} else {
						console.error("Add Data form not found");
					}

					function fetchData(view) {
						console.log("Fetching data for view:", view);
						fetch(`{{ url_for('main.glucose_data') }}?view=${view}`)
							.then((response) => response.json())
							.then((data) => {
								console.log("Data fetched:", data);
								updateChart(data);
							})
							.catch((error) => console.error("Error fetching data:", error));
					}

					function updateChart(data) {
						console.log("Updating chart with data:", data);
						const ctx = document
							.getElementById("glucoseChart")
							.getContext("2d");
						if (glucoseChart) {
							glucoseChart.destroy();
						}
						glucoseChart = new Chart(ctx, {
							type: "line",
							data: {
								datasets: [
									{
										label: "Glucose Level",
										data: data.map((entry) => ({
											x: moment(entry.timestamp),
											y: entry.glucose_level,
										})),
										borderColor: "rgb(255, 99, 132)",
										fill: false,
									},
								],
							},
							options: {
								scales: {
									x: {
										type: "time",
										time: {
											unit: "day",
										},
									},
									y: {
										beginAtZero: false,
									},
								},
							},
						});
					}

					if (dayViewButton) {
						dayViewButton.addEventListener("click", () => fetchData("day"));
					} else {
						console.error("Day view button not found");
					}

					if (weekViewButton) {
						weekViewButton.addEventListener("click", () => fetchData("week"));
					} else {
						console.error("Week view button not found");
					}

					if (monthViewButton) {
						monthViewButton.addEventListener("click", () => fetchData("month"));
					} else {
						console.error("Month view button not found");
					}

					fetchData("day");
				}

				icons.forEach((icon) => {
					icon.addEventListener("click", function () {
						const tabId = this.getAttribute("data-tab");
						activateTab(tabId);
					});
				});

				const activeTab = localStorage.getItem("activeTab") || "explore";
				activateTab(activeTab, false);
				loadContent(activeTab, setActiveIcon);
			});
		</script>
	</body>
</html>
