<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Dashboard</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
		<style>
			.popup-message {
				position: fixed;
				top: 10%;
				left: 50%;
				transform: translateX(-50%);
				z-index: 50;
				padding: 10px 20px;
				border-radius: 8px;
				background-color: #48bb78; /* Tailwind's green-500 */
				color: white;
				display: none;
				opacity: 0;
				transition: opacity 0.5s ease;
			}
			.popup-message.error {
				background-color: #f56565; /* Tailwind's red-500 */
			}
			.popup-message.show {
				display: block;
				opacity: 1;
			}
		</style>
	</head>
	<body class="flex h-screen bg-gray-100">
		<div class="flex flex-col md:flex-row w-full">
			<!-- Sidebar -->
			<nav
				class="bg-white md:w-16 w-full md:h-full h-16 fixed md:fixed bottom-0 md:bottom-auto flex md:flex-col md:justify-between shadow-lg"
			>
				<div
					class="flex md:flex-col items-center mobile-centered md:mt-4 space-x-4 md:space-x-0 md:space-y-4 w-full"
				>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="summary-tab"
						data-tab="summary"
					>
						<i class="far fa-heart text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Summary</span
						>
					</div>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="profile-tab"
						data-tab="profile"
					>
						<i class="far fa-user text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Profile</span
						>
					</div>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="explore-tab"
						data-tab="explore"
					>
						<i class="far fa-compass text-gray-600 text-lg md:text-2xl"></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Explore</span
						>
					</div>
				</div>
				<div
					class="md:mb-4 flex md:flex-col items-center justify-around md:justify-end space-x-4 md:space-x-0 md:space-y-4 logout-icon hidden md:flex"
				>
					<div
						class="flex flex-col items-center sidebar-icon p-2"
						id="logout-tab"
						onclick="location.href='{{ url_for('auth.sign_out') }}'"
					>
						<i
							class="far fa-sign-out-alt text-gray-600 text-lg md:text-2xl"
						></i>
						<span class="icon-label text-gray-600 text-xs md:text-base"
							>Logout</span
						>
					</div>
				</div>
			</nav>

			<!-- Main Content -->
			<main class="flex-1 p-4 md:ml-16" id="main-content">
				<!-- Initial content will be loaded here -->
			</main>
		</div>

		<script>
			const icons = document.querySelectorAll(".sidebar-icon");

			let healthTrendChart; // Declare chart variable globally

			function loadContent(tabId, callback) {
				let url = `/${tabId}`;
				if (tabId === "explore") {
					url = "{{ url_for('main.explore_content') }}";
				} else if (tabId === "heart_rate") {
					url = "{{ url_for('main.heart_rate') }}";
				} else if (tabId === "cholesterol") {
					url = "{{ url_for('main.cholesterol') }}";
				} else if (tabId === "glucose") {
					url = "{{ url_for('main.glucose') }}";
				}
				fetch(url)
					.then((response) => response.text())
					.then((html) => {
						document.getElementById("main-content").innerHTML = html;
						if (tabId === "explore") {
							setupExplorePage();
						}
						if (tabId === "summary") {
							summaryPage();
						}
						if (callback) callback(tabId);
						if (tabId === "blood_pressure") {
							setupBloodPressurePage();
						}
						if (tabId === "heart_rate") {
							setupHeartRatePage();
						}
						if (tabId === "glucose") {
							setupGlucosePage();
						}
						if (tabId === "cholesterol") {
							setupCholesterolPage();
						}
					})
					.catch((error) => console.warn("Error loading content:", error));
			}

			function activateTab(tabId, shouldLoadContent = true) {
				localStorage.setItem("activeTab", tabId);
				console.log(`Activating tab: ${tabId}`);

				if (shouldLoadContent) {
					loadContent(tabId, setActiveIcon);
				} else {
					setActiveIcon(tabId);
				}
			}

			function setActiveIcon(tabId) {
				console.log(`Setting active icon for tab: ${tabId}`);
				icons.forEach((i) => {
					const iconLabel = i.querySelector(".icon-label");
					const icon = i.querySelector("i");

					if (iconLabel) {
						iconLabel.classList.remove("active");
						iconLabel.style.color = "#6b7280"; // Tailwind's gray-600
					}
					if (icon) {
						// Reset all icons to outline and gray color
						icon.className = icon.className.replace("fas", "far"); // Switch from filled to outline
						icon.style.color = "#6b7280"; // Tailwind's gray-600
					}
				});

				const activeIcon = document.querySelector(`#${tabId}-tab`);
				if (activeIcon) {
					const activeLabel = activeIcon.querySelector(".icon-label");
					const activeIconElement = activeIcon.querySelector("i");

					if (activeLabel) {
						activeLabel.classList.add("active");
						activeLabel.style.color = "#b91c1c"; // Tailwind's red-700
					}
					if (activeIconElement) {
						// Change to filled icon when active
						activeIconElement.className = activeIconElement.className.replace("far", "fas"); // Switch from outline to filled
						activeIconElement.style.color = "#b91c1c"; // Tailwind's red-700
					}
				}
			}



			icons.forEach((icon) => {
				icon.addEventListener("click", function () {
					const tabId = this.getAttribute("data-tab");
					console.log(`Icon clicked for tab: ${tabId}`);
					activateTab(tabId);
				});
			});

			const activeTab = localStorage.getItem("activeTab") || "explore";
			activateTab(activeTab, false);
			loadContent(activeTab, setActiveIcon);


			function setupExplorePage() {
				document
					.getElementById("bp-link")
					.addEventListener("click", function (event) {
						event.preventDefault();
						loadContent("blood_pressure", () => setActiveIcon("explore"));
					});

				document
					.getElementById("hr-link")
					.addEventListener("click", function (event) {
						event.preventDefault();
						loadContent("heart_rate", () => setActiveIcon("explore"));
					});

				document
					.getElementById("cholesterol-link")
					.addEventListener("click", function (event) {
						event.preventDefault();
						loadContent("cholesterol", () => setActiveIcon("explore"));
					});

				document
					.getElementById("glucose-link")
					.addEventListener("click", function (event) {
						event.preventDefault();
						loadContent("glucose", () => setActiveIcon("explore"));
					});
			}

			function setupCholesterolPage() {
				console.log("Setting up Cholesterol Page");

				const addDataButton = document.getElementById("addDataButton");
				const addDataModal = document.getElementById("addDataModal");
				const closeModalButton = document.getElementById("closeModalButton");
				const closeModalButtonTop = document.getElementById(
					"closeModalButtonTop"
				);
				const addDataForm = document.getElementById("addDataForm");
				const formMessage = document.getElementById("formMessage");
				const formErrorMessage = document.getElementById("formErrorMessage");
				const dayViewButton = document.getElementById("dayView");
				const weekViewButton = document.getElementById("weekView");
				const monthViewButton = document.getElementById("monthView");

				let cholesterolChart;

				const closeModal = () => {
					addDataModal.classList.add("hidden");
				};

				const showMessage = (message, isSuccess = true) => {
					const messageContainer = document.createElement("div");
					messageContainer.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg ${
						isSuccess ? "bg-green-500 text-white" : "bg-red-500 text-white"
					}`;
					messageContainer.textContent = message;
					document.body.appendChild(messageContainer);

					setTimeout(() => {
						messageContainer.remove();
					}, 3000);
				};

				addDataButton.addEventListener("click", function () {
					addDataModal.classList.remove("hidden");
				});

				closeModalButton.addEventListener("click", closeModal);
				closeModalButtonTop.addEventListener("click", closeModal);

				addDataForm.addEventListener("submit", function (event) {
					event.preventDefault();
					const formData = new FormData(addDataForm);

					fetch(addDataForm.action, {
						method: "POST",
						body: formData,
					})
						.then((response) => response.json())
						.then((data) => {
							if (data.success) {
								showMessage("Data added successfully!", true);
								fetchData("day");
							} else {
								showMessage("Error adding data!", false);
							}
						})
						.catch((error) => {
							showMessage("Error adding data!", false);
							console.error("Error:", error);
						});
				});

				const fetchData = (view) => {
					fetch(`{{ url_for('main.cholesterol_data') }}?view=${view}`)
						.then((response) => response.json())
						.then((data) => {
							console.log("Data fetched for view:", view, data); // Debugging
							updateChart(data);
						})
						.catch((error) => console.error("Error fetching data:", error));
				};

				const updateChart = (data) => {
					const ctx = document
						.getElementById("cholesterolChart")
						.getContext("2d");
					if (cholesterolChart) {
						cholesterolChart.destroy();
					}
					cholesterolChart = new Chart(ctx, {
						type: "line",
						data: {
							datasets: [
								{
									label: "Cholesterol Level",
									data: data.map((entry) => ({
										x: moment(entry.timestamp),
										y: entry.cholesterol_level,
									})),
									borderColor: "rgb(255, 99, 132)",
									fill: false,
								},
							],
						},
						options: {
							scales: {
								x: {
									type: "time",
									time: {
										unit: "day",
									},
								},
								y: {
									beginAtZero: false,
								},
							},
						},
					});
				};

				dayViewButton.addEventListener("click", () => fetchData("day"));
				weekViewButton.addEventListener("click", () => fetchData("week"));
				monthViewButton.addEventListener("click", () => fetchData("month"));

				// Initialize the chart with the default view
				fetchData("day");
			}

			function setupBloodPressurePage() {
				console.log("Setting up Blood Pressure Page");

				const addDataButton = document.getElementById("addDataButton");
				const addDataModal = document.getElementById("addDataModal");
				const closeModalButton = document.getElementById("closeModalButton");
				const closeModalButtonTop = document.getElementById(
					"closeModalButtonTop"
				);
				const addDataForm = document.getElementById("addDataForm");
				const formMessage = document.getElementById("formMessage");
				const formErrorMessage = document.getElementById("formErrorMessage");
				const dayViewButton = document.getElementById("dayView");
				const weekViewButton = document.getElementById("weekView");
				const monthViewButton = document.getElementById("monthView");

				let bpChart;

				if (addDataButton) {
					addDataButton.addEventListener("click", function () {
						console.log("Add Data button clicked");
						addDataModal.classList.remove("hidden");
						console.log("Modal should be visible now");
					});
				} else {
					console.error("Add Data button not found");
				}

				if (closeModalButton) {
					closeModalButton.addEventListener("click", function () {
						console.log("Close button clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button not found");
				}

				if (closeModalButtonTop) {
					closeModalButtonTop.addEventListener("click", function () {
						console.log("Close button (top) clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button (top) not found");
				}

				if (addDataForm) {
					addDataForm.addEventListener("submit", function (event) {
						event.preventDefault();
						console.log("Form submitted");
						const formData = new FormData(addDataForm);

						fetch(addDataForm.action, {
							method: "POST",
							body: formData,
						})
							.then((response) => response.json())
							.then((data) => {
								if (data.success) {
									console.log("Data added successfully");
									formMessage.classList.remove("hidden");
									formErrorMessage.classList.add("hidden");
									formMessage.textContent = "Data added successfully!";
									setTimeout(() => {
										formMessage.classList.add("hidden");
										addDataModal.classList.add("hidden");
										fetchData("day");
									}, 2000);
								} else {
									console.log("Error adding data");
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								}
							})
							.catch((error) => {
								console.log("Error:", error);
								formErrorMessage.classList.remove("hidden");
								formMessage.classList.add("hidden");
								formErrorMessage.textContent = "Error adding data!";
							});
					});
				} else {
					console.error("Add Data form not found");
				}

				function fetchData(view) {
					console.log("Fetching data for view:", view);
					fetch(`{{ url_for('main.blood_pressure_data') }}?view=${view}`)
						.then((response) => response.json())
						.then((data) => {
							console.log("Data fetched:", data);
							updateChart(data);
						})
						.catch((error) => console.error("Error fetching data:", error));
				}

				function updateChart(data) {
					console.log("Updating chart with data:", data);
					const ctx = document.getElementById("bpChart").getContext("2d");
					if (bpChart) {
						bpChart.destroy();
					}
					bpChart = new Chart(ctx, {
						type: "line",
						data: {
							datasets: [
								{
									label: "Systolic",
									data: data.map((entry) => ({
										x: moment(entry.timestamp),
										y: entry.systolic,
									})),
									borderColor: "rgb(255, 99, 132)",
									fill: false,
								},
								{
									label: "Diastolic",
									data: data.map((entry) => ({
										x: moment(entry.timestamp),
										y: entry.diastolic,
									})),
									borderColor: "rgb(54, 162, 235)",
									fill: false,
								},
							],
						},
						options: {
							scales: {
								x: {
									type: "time",
									time: {
										unit: "day",
									},
								},
								y: {
									beginAtZero: false,
								},
							},
						},
					});
				}

				if (dayViewButton) {
					dayViewButton.addEventListener("click", () => fetchData("day"));
				} else {
					console.error("Day view button not found");
				}

				if (weekViewButton) {
					weekViewButton.addEventListener("click", () => fetchData("week"));
				} else {
					console.error("Week view button not found");
				}

				if (monthViewButton) {
					monthViewButton.addEventListener("click", () => fetchData("month"));
				} else {
					console.error("Month view button not found");
				}

				fetchData("day");
			}

			function setupHeartRatePage() {
				console.log("Setting up Heart Rate Page");

				const addDataButton = document.getElementById("addDataButton");
				const addDataModal = document.getElementById("addDataModal");
				const closeModalButton = document.getElementById("closeModalButton");
				const closeModalButtonTop = document.getElementById(
					"closeModalButtonTop"
				);
				const addDataForm = document.getElementById("addDataForm");
				const formMessage = document.getElementById("formMessage");
				const formErrorMessage = document.getElementById("formErrorMessage");
				const dayViewButton = document.getElementById("dayView");
				const weekViewButton = document.getElementById("weekView");
				const monthViewButton = document.getElementById("monthView");

				let hrChart;

				if (addDataButton) {
					addDataButton.addEventListener("click", function () {
						console.log("Add Data button clicked");
						addDataModal.classList.remove("hidden");
						console.log("Modal should be visible now");
					});
				} else {
					console.error("Add Data button not found");
				}

				if (closeModalButton) {
					closeModalButton.addEventListener("click", function () {
						console.log("Close button clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button not found");
				}

				if (closeModalButtonTop) {
					closeModalButtonTop.addEventListener("click", function () {
						console.log("Close button (top) clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button (top) not found");
				}

				if (addDataForm) {
					addDataForm.addEventListener("submit", function (event) {
						event.preventDefault();
						console.log("Form submitted");
						const formData = new FormData(addDataForm);

						fetch(addDataForm.action, {
							method: "POST",
							body: formData,
						})
							.then((response) => response.json())
							.then((data) => {
								if (data.success) {
									console.log("Data added successfully");
									formMessage.classList.remove("hidden");
									formErrorMessage.classList.add("hidden");
									formMessage.textContent = "Data added successfully!";
									setTimeout(() => {
										formMessage.classList.add("hidden");
										addDataModal.classList.add("hidden");
										fetchData("day");
									}, 2000);
								} else {
									console.log("Error adding data");
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								}
							})
							.catch((error) => {
								console.log("Error:", error);
								formErrorMessage.classList.remove("hidden");
								formMessage.classList.add("hidden");
								formErrorMessage.textContent = "Error adding data!";
							});
					});
				} else {
					console.error("Add Data form not found");
				}

				function fetchData(view) {
					console.log("Fetching data for view:", view);
					fetch(`{{ url_for('main.heart_rate_data') }}?view=${view}`)
						.then((response) => response.json())
						.then((data) => {
							console.log("Data fetched:", data);
							updateChart(data);
						})
						.catch((error) => console.error("Error fetching data:", error));
				}

				function updateChart(data) {
					console.log("Updating chart with data:", data);
					const ctx = document.getElementById("hrChart").getContext("2d");
					if (hrChart) {
						hrChart.destroy();
					}
					hrChart = new Chart(ctx, {
						type: "line",
						data: {
							datasets: [
								{
									label: "Heart Rate",
									data: data.map((entry) => ({
										x: moment(entry.timestamp),
										y: entry.heart_rate,
									})),
									borderColor: "rgb(255, 99, 132)",
									fill: false,
								},
							],
						},
						options: {
							scales: {
								x: {
									type: "time",
									time: {
										unit: "day",
									},
								},
								y: {
									beginAtZero: false,
								},
							},
						},
					});
				}

				if (dayViewButton) {
					dayViewButton.addEventListener("click", () => fetchData("day"));
				} else {
					console.error("Day view button not found");
				}

				if (weekViewButton) {
					weekViewButton.addEventListener("click", () => fetchData("week"));
				} else {
					console.error("Week view button not found");
				}

				if (monthViewButton) {
					monthViewButton.addEventListener("click", () => fetchData("month"));
				} else {
					console.error("Month view button not found");
				}

				fetchData("day");
			}

			function setupGlucosePage() {
				console.log("Setting up Glucose Page");

				const addDataButton = document.getElementById("addDataButton");
				const addDataModal = document.getElementById("addDataModal");
				const closeModalButton = document.getElementById("closeModalButton");
				const closeModalButtonTop = document.getElementById(
					"closeModalButtonTop"
				);
				const addDataForm = document.getElementById("addDataForm");
				const formMessage = document.getElementById("formMessage");
				const formErrorMessage = document.getElementById("formErrorMessage");
				const dayViewButton = document.getElementById("dayView");
				const weekViewButton = document.getElementById("weekView");
				const monthViewButton = document.getElementById("monthView");

				let glucoseChart;

				if (addDataButton) {
					addDataButton.addEventListener("click", function () {
						console.log("Add Data button clicked");
						addDataModal.classList.remove("hidden");
						console.log("Modal should be visible now");
					});
				} else {
					console.error("Add Data button not found");
				}

				if (closeModalButton) {
					closeModalButton.addEventListener("click", function () {
						console.log("Close button clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button not found");
				}

				if (closeModalButtonTop) {
					closeModalButtonTop.addEventListener("click", function () {
						console.log("Close button (top) clicked");
						addDataModal.classList.add("hidden");
					});
				} else {
					console.error("Close button (top) not found");
				}

				if (addDataForm) {
					addDataForm.addEventListener("submit", function (event) {
						event.preventDefault();
						console.log("Form submitted");
						const formData = new FormData(addDataForm);

						fetch(addDataForm.action, {
							method: "POST",
							body: formData,
						})
							.then((response) => response.json())
							.then((data) => {
								if (data.success) {
									console.log("Data added successfully");
									formMessage.classList.remove("hidden");
									formErrorMessage.classList.add("hidden");
									formMessage.textContent = "Data added successfully!";
									setTimeout(() => {
										formMessage.classList.add("hidden");
										addDataModal.classList.add("hidden");
										fetchData("day");
									}, 2000);
								} else {
									console.log("Error adding data");
									formErrorMessage.classList.remove("hidden");
									formMessage.classList.add("hidden");
									formErrorMessage.textContent = "Error adding data!";
								}
							})
							.catch((error) => {
								console.log("Error:", error);
								formErrorMessage.classList.remove("hidden");
								formMessage.classList.add("hidden");
								formErrorMessage.textContent = "Error adding data!";
							});
					});
				} else {
					console.error("Add Data form not found");
				}

				function fetchData(view) {
					console.log("Fetching data for view:", view);
					fetch(`{{ url_for('main.glucose_data') }}?view=${view}`)
						.then((response) => response.json())
						.then((data) => {
							console.log("Data fetched:", data);
							updateChart(data);
						})
						.catch((error) => console.error("Error fetching data:", error));
				}

				function updateChart(data) {
					console.log("Updating chart with data:", data);
					const ctx = document.getElementById("glucoseChart").getContext("2d");
					if (glucoseChart) {
						glucoseChart.destroy();
					}
					glucoseChart = new Chart(ctx, {
						type: "line",
						data: {
							datasets: [
								{
									label: "Glucose Level",
									data: data.map((entry) => ({
										x: moment(entry.timestamp),
										y: entry.glucose_level,
									})),
									borderColor: "rgb(255, 99, 132)",
									fill: false,
								},
							],
						},
						options: {
							scales: {
								x: {
									type: "time",
									time: {
										unit: "day",
									},
								},
								y: {
									beginAtZero: false,
								},
							},
						},
					});
				}

				if (dayViewButton) {
					dayViewButton.addEventListener("click", () => fetchData("day"));
				} else {
					console.error("Day view button not found");
				}

				if (weekViewButton) {
					weekViewButton.addEventListener("click", () => fetchData("week"));
				} else {
					console.error("Week view button not found");
				}

				if (monthViewButton) {
					monthViewButton.addEventListener("click", () => fetchData("month"));
				} else {
					console.error("Month view button not found");
				}

				fetchData("day");
			}



			function summaryPage() {
				// Modal Buttons
				const addBPButton = document.getElementById("addBP");
				const addCholesterolButton = document.getElementById("addCholesterol");
				const addGlucoseButton = document.getElementById("addGlucose");
				const addHeartRateButton = document.getElementById("addHeartRate");

				// Modals
				const addBPModal = document.getElementById("addBPModal");
				const addCholesterolModal = document.getElementById("addCholesterolModal");
				const addGlucoseModal = document.getElementById("addGlucoseModal");
				const addHeartRateModal = document.getElementById("addHeartRateModal");

				// Modal Close Buttons
				const closeBPModalButton = document.getElementById("closeBPModalButton");
				const closeBPModalButtonTop = document.getElementById("closeBPModalButtonTop");
				const closeCholesterolModalButton = document.getElementById("closeCholesterolModalButton");
				const closeCholesterolModalButtonTop = document.getElementById("closeCholesterolModalButtonTop");
				const closeGlucoseModalButton = document.getElementById("closeGlucoseModalButton");
				const closeGlucoseModalButtonTop = document.getElementById("closeGlucoseModalButtonTop");
				const closeHeartRateModalButton = document.getElementById("closeHeartRateModalButton");
				const closeHeartRateModalButtonTop = document.getElementById("closeHeartRateModalButtonTop");

				// Forms
				const bpForm = document.getElementById("addBPForm");
				const cholesterolForm = document.getElementById("addCholesterolForm");
				const glucoseForm = document.getElementById("addGlucoseForm");
				const heartRateForm = document.getElementById("addHeartRateForm");

				// Messages
				const bpFormMessage = document.getElementById("bpFormMessage");
				const bpFormErrorMessage = document.getElementById("bpFormErrorMessage");
				const cholesterolFormMessage = document.getElementById("cholesterolFormMessage");
				const cholesterolFormErrorMessage = document.getElementById("cholesterolFormErrorMessage");
				const glucoseFormMessage = document.getElementById("glucoseFormMessage");
				const glucoseFormErrorMessage = document.getElementById("glucoseFormErrorMessage");
				const heartRateFormMessage = document.getElementById("heartRateFormMessage");
				const heartRateFormErrorMessage = document.getElementById("heartRateFormErrorMessage");

				// Show BP Modal
				addBPButton.addEventListener("click", function () {
					addBPModal.classList.remove("hidden");
					addCholesterolModal.classList.add("hidden");
					addGlucoseModal.classList.add("hidden");
					addHeartRateModal.classList.add("hidden");
				});

				// Show Cholesterol Modal
				addCholesterolButton.addEventListener("click", function () {
					addCholesterolModal.classList.remove("hidden");
					addBPModal.classList.add("hidden");
					addGlucoseModal.classList.add("hidden");
					addHeartRateModal.classList.add("hidden");
				});

				// Show Glucose Modal
				addGlucoseButton.addEventListener("click", function () {
					addGlucoseModal.classList.remove("hidden");
					addBPModal.classList.add("hidden");
					addCholesterolModal.classList.add("hidden");
					addHeartRateModal.classList.add("hidden");
				});

				// Show Heart Rate Modal
				addHeartRateButton.addEventListener("click", function () {
					addHeartRateModal.classList.remove("hidden");
					addBPModal.classList.add("hidden");
					addCholesterolModal.classList.add("hidden");
					addGlucoseModal.classList.add("hidden");
				});

				// Close BP Modal
				[closeBPModalButton, closeBPModalButtonTop].forEach((button) => {
					button.addEventListener("click", function () {
						addBPModal.classList.add("hidden");
					});
				});

				// Close Cholesterol Modal
				[closeCholesterolModalButton, closeCholesterolModalButtonTop].forEach((button) => {
					button.addEventListener("click", function () {
						addCholesterolModal.classList.add("hidden");
					});
				});

				// Close Glucose Modal
				[closeGlucoseModalButton, closeGlucoseModalButtonTop].forEach((button) => {
					button.addEventListener("click", function () {
						addGlucoseModal.classList.add("hidden");
					});
				});

				// Close Heart Rate Modal
				[closeHeartRateModalButton, closeHeartRateModalButtonTop].forEach((button) => {
					button.addEventListener("click", function () {
						addHeartRateModal.classList.add("hidden");
					});
				});

				// Handle BP Form Submission
				bpForm.addEventListener("submit", function (event) {
					event.preventDefault();
					const formData = new FormData(bpForm);
					fetch(bpForm.action, {
						method: "POST",
						body: formData,
					})
						.then((response) => {
							if (response.ok) {
								bpFormMessage.classList.remove("hidden");
								bpFormErrorMessage.classList.add("hidden");
								bpForm.reset(); // Clear form after success
							} else {
								bpFormErrorMessage.classList.remove("hidden");
								bpFormMessage.classList.add("hidden");
							}
						})
						.catch(() => {
							bpFormErrorMessage.classList.remove("hidden");
							bpFormMessage.classList.add("hidden");
						});
				});

				// Handle Cholesterol Form Submission
				cholesterolForm.addEventListener("submit", function (event) {
					event.preventDefault();
					const formData = new FormData(cholesterolForm);
					fetch(cholesterolForm.action, {
						method: "POST",
						body: formData,
					})
						.then((response) => {
							if (response.ok) {
								cholesterolFormMessage.classList.remove("hidden");
								cholesterolFormErrorMessage.classList.add("hidden");
								cholesterolForm.reset(); // Clear form after success
							} else {
								cholesterolFormErrorMessage.classList.remove("hidden");
								cholesterolFormMessage.classList.add("hidden");
							}
						})
						.catch(() => {
							cholesterolFormErrorMessage.classList.remove("hidden");
							cholesterolFormMessage.classList.add("hidden");
						});
				});

				// Handle Glucose Form Submission
				glucoseForm.addEventListener("submit", function (event) {
					event.preventDefault();
					const formData = new FormData(glucoseForm);
					fetch(glucoseForm.action, {
						method: "POST",
						body: formData,
					})
						.then((response) => {
							if (response.ok) {
								glucoseFormMessage.classList.remove("hidden");
								glucoseFormErrorMessage.classList.add("hidden");
								glucoseForm.reset(); // Clear form after success
							} else {
								glucoseFormErrorMessage.classList.remove("hidden");
								glucoseFormMessage.classList.add("hidden");
							}
						})
						.catch(() => {
							glucoseFormErrorMessage.classList.remove("hidden");
							glucoseFormMessage.classList.add("hidden");
						});
				});

				// Handle Heart Rate Form Submission
				heartRateForm.addEventListener("submit", function (event) {
					event.preventDefault();
					const formData = new FormData(heartRateForm);
					fetch(heartRateForm.action, {
						method: "POST",
						body: formData,
					})
						.then((response) => {
							if (response.ok) {
								heartRateFormMessage.classList.remove("hidden");
								heartRateFormErrorMessage.classList.add("hidden");
								heartRateForm.reset(); // Clear form after success
							} else {
								heartRateFormErrorMessage.classList.remove("hidden");
								heartRateFormMessage.classList.add("hidden");
							}
						})
						.catch(() => {
							heartRateFormErrorMessage.classList.remove("hidden");
							heartRateFormMessage.classList.add("hidden");
						});
				});

				// Show message if no data
				const bpChartData = {{ bp_chart_data|tojson }};
				const cholesterolChartData = {{ cholesterol_chart_data|tojson }};
				const heartRateChartData = {{ heart_rate_chart_data|tojson }};
				const glucoseChartData = {{ glucose_chart_data|tojson }};

				if (!bpChartData.length && !cholesterolChartData.length && !heartRateChartData.length && !glucoseChartData.length) {
					document.getElementById('no-data-message').classList.remove('hidden');
					document.getElementById('healthTrendChart').classList.add('hidden');
				} else {
					document.getElementById('no-data-message').classList.add('hidden');
					document.getElementById('healthTrendChart').classList.remove('hidden');
					healthTrend(bpChartData, cholesterolChartData, heartRateChartData, glucoseChartData);
				}

				// JavaScript to dynamically insert current date
				const currentDate = new Date().toLocaleDateString('en-GB', {
					day: 'numeric',
					month: 'long',
					year: 'numeric'
				});
				document.getElementById('current-date').textContent = currentDate;


			// Call the function with the data from Flask
			healthTrend(
				{{ bp_chart_data|tojson }},
				{{ cholesterol_chart_data|tojson }},
				{{ heart_rate_chart_data|tojson }},
				{{ glucose_chart_data|tojson }}
			);
			}


			function healthTrend(bpData, cholesterolData, heartRateData, glucoseData) {
				// If no data, provide default empty arrays
				bpData = bpData || [];
				cholesterolData = cholesterolData || [];
				heartRateData = heartRateData || [];
				glucoseData = glucoseData || [];

				// Prepare the labels (dates)
				const labels = bpData.length ? bpData.map(d => d.timestamp) : cholesterolData.length ? cholesterolData.map(d => d.timestamp) : heartRateData.length ? heartRateData.map(d => d.timestamp) : glucoseData.length ? glucoseData.map(d => d.timestamp) : [];

				// Prepare data for Chart.js
				const systolicData = bpData.length ? bpData.map(d => d.systolic) : [];
				const diastolicData = bpData.length ? bpData.map(d => d.diastolic) : [];
				const cholesterolLevels = cholesterolData.length ? cholesterolData.map(d => d.cholesterol_level) : [];
				const heartRates = heartRateData.length ? heartRateData.map(d => d.heart_rate) : [];
				const glucoseLevels = glucoseData.length ? glucoseData.map(d => d.glucose_level) : [];

				// Check if there is any data to show
				if (labels.length) {
					const ctx = document.getElementById('healthTrendChart').getContext('2d');

					// Destroy existing chart instance if it exists
					if (healthTrendChart) {
						healthTrendChart.destroy();
						healthTrendChart = null; // Ensure it's reset to null
					}

					healthTrendChart = new Chart(ctx, {
						type: 'line',
						data: {
							labels: labels,
							datasets: [
								systolicData.length ? {
									label: 'Systolic Blood Pressure',
									data: systolicData,
									borderColor: 'rgb(255, 99, 132)',
									backgroundColor: 'rgba(255, 99, 132, 0.2)',
									fill: false,
									tension: 0.1
								} : null,
								diastolicData.length ? {
									label: 'Diastolic Blood Pressure',
									data: diastolicData,
									borderColor: 'rgb(54, 162, 235)',
									backgroundColor: 'rgba(54, 162, 235, 0.2)',
									fill: false,
									tension: 0.1
								} : null,
								cholesterolLevels.length ? {
									label: 'Cholesterol Level',
									data: cholesterolLevels,
									borderColor: 'rgb(255, 206, 86)',
									backgroundColor: 'rgba(255, 206, 86, 0.2)',
									fill: false,
									tension: 0.1
								} : null,
								heartRates.length ? {
									label: 'Heart Rate',
									data: heartRates,
									borderColor: 'rgb(75, 192, 192)',
									backgroundColor: 'rgba(75, 192, 192, 0.2)',
									fill: false,
									tension: 0.1
								} : null,
								glucoseLevels.length ? {
									label: 'Glucose Level',
									data: glucoseLevels,
									borderColor: 'rgb(153, 102, 255)',
									backgroundColor: 'rgba(153, 102, 255, 0.2)',
									fill: false,
									tension: 0.1
								} : null
							].filter(dataset => dataset !== null) // Filter out null datasets
						},
						options: {
							responsive: true,
							maintainAspectRatio: false, // Ensures the chart adjusts correctly
							plugins: {
								legend: {
									position: 'top',
								},
								title: {
									display: true,
									text: 'Health Trends Over Time'
								}
							},
							scales: {
								x: {
									type: 'time',
									time: {
										unit: 'day'
									},
									title: {
										display: true,
										text: 'Date'
									}
								},
								y: {
									title: {
										display: true,
										text: 'Values'
									},
									min: 0,
									suggestedMax: 200
								}
							}
						}
					});
				}
			}
		</script>
	</body>
</html>
